---
categories: 测试
tags: 测试 抓包
---

## 中间人抓https包的基本原理

```mermaid!
pie title Pets adopted by volunteers
  "Dogs" : 386
  "Cats" : 85
  "Rats" : 35
```

>中间人本质就是
对客户端伪造自己是服务端
对服务端伪造自己是客户端

下图展示了常见的TLS四次握手的过程中抓包软件如何工作

```mermaid!
sequenceDiagram

participant C as 客户端
participant M as 中间人
participant S as 服务器

C ->> M:客户端向服务器请求证书
M ->> S:拦截,假装自己是客户端向服务器请求证书
S -->> M:服务器返回证书
M -->> C:拦截,由证书获取服务器公钥.将服务端证书替换为自己的证书

C ->> C:验证证书有效性,由于手机安装并信任了中间人证书,则验证通过
C ->> M:使用证书的公钥加密对称密钥,发送给服务器
M ->> S:拦截,使用证书私钥解密得到对称密钥,再使用服务器公钥加密发给服务器
S -->> M:服务器使用私钥解密得到对称密钥,发送响应
M -->> C:拦截,将自己伪装成真实服务器,响应给客户端

```

可以看到中间人成功在TLS的握手过程中拿到了会话加密用的对称密钥
>TLS1.3版本仅需两次握手,一个RTT时间,工作的核心逻辑不变

## 常见反抓包手段

- **证书固定**，客户端应用内置了服务端证书
- **双向认证**，不仅仅客户端校验服务器证书，服务器也要校验客户端证书
- **系统限制**，如安卓高版本默认不信任用户安装的证书

### 证书固定

客户端应用内置了服务端证书，客户端应用会校验中间人服务端返回的证书是否与内置服务端证书一致
>有些服务端证书是自签名的（没有找第三方CA），那么应用一定会有证书固定

对于这种情况，一般有两类处理办法

1. 找后端要公钥证书以及私钥（逆向可以获取公钥证书，但是没有私钥看不到任何明文数据），导入抓包软件，让抓包软件成为更“真”的服务端
2. hook掉客户端相关验证服务端证书的方法，使客户端应用不再验证内置证书

对于第二点，在安卓上Xposed 和 Magisk 都有相应的模块，实现了该功能

### 双向认证

客户端额外内置一套公钥证书和私钥，在TLS握手流程中，服务器验证客户端的身份（应该是TLS第三次握手时发送给服务端，服务端校验证书可信后，用客户端证书公钥加密发送数据，有误的话请指正）

对于这种，需要逆向获得客户端应用的公钥证书和私钥，导入抓包软件，让抓包软件成为更“真”的客户端

### 系统限制

已知Android7.0以后系统不在信任用户的证书.这种情况下有以下几种选择：

1. 用模拟器，使用低版本的安卓系统
2. root手机，将证书放置在系统目录下
3. 找开发修改 targetSDKVersion使其小于23，重新编译打包
