---
categories: 测试
tags: 测试
---

## 架构概述

事件驱动架构（Event-Driven Architecture），缩写为EDA

关注事件的产生、识别、存储、处理（消费）、响应。

>需要注意异步特性导致的缺陷和事件队列处理可能存在的全局性缺陷

参照维基百科中定义：一个事物“状态”的显著变化可被称为一个事件。在实际沟通中中我们为了简化，一般把事件通知的消息内容称为事件

事件驱动架构一般包含以下架构组件

- 事件（通知）。由内/外事件触发的特殊消息。
- 事件队列。用于接受缓存事件（通知），有着处理顺序，优先级，缓存溢出等复杂逻辑。
- 事件分发器。对事件预处理，将其分发到对应的对这个事件有兴趣的处理逻辑中，事件分发器的实现**主要有"事件流"式处理和“注册/发布”式处理**两种不同的实现方式。
- 事件通道。分发器通过事件通道将事件通知分发到不同的事件处理逻辑中。一般一大类事件对应一个事件通道，这个通道可以看作一个小型的“事件队列”，小型系统可以简化掉这一部分。
- 事件处理逻辑。实现具体的业务逻辑，有时可以将这一部分进步步通过状态机模型来实现。

>事件的收发和处理是异步的，因此测试时需要注意异步通信中的常见问题，比如：事件通知丢失，事件队列溢出，事件失去响应，事件通知重复，事件未被订阅等

## 事件渠道架构组件与其质量特性

事件（通知）、事件队列。、事件分发器，事件通道这四个架构组件实现的功能如下：

1. 事件通知的编码解码（可选）
2. 事件通知的发送与接收
3. 事件队列的管理与维护
4. 事件的注册/注销
5. 事件的优先级（可选）
6. 事件与注册记录的匹配和过滤
7. 事件的广播/转发
8. 事件通道的创建、管理和维护（可选）
9. 事件处理机制的调用方法
10. 事件处理后的返回和/或后续处理（可选）

各个功能与对应质量特性的关系大致如下表（摘自《软件评测师》）：

质量特性如下：

- 功能性
  - 完备性
  - 正确性
  - 适合性
- 性能效率
  - 时间特性
  - 资源利用性
  - 容量
- 易用性
  - 可辨识性
  - 易学性
  - 易操作性
  - 用户差错防御性
  - 用户界面舒适性
  - 易访问性
- 可靠性
  - 成熟性
  - 可用性
  - 容错性
  - 易恢复性
- 信息安全性
  - 保密性
  - 完整性
  - 抗抵赖性
  - 可核查性
  - 真实性
- 维护性
  - 模块化
  - 可重用性
  - 易分析性
  - 易修改性
  - 易测试性
- 兼容性
  - 共存性
  - 互操作性
- 可移植性
  - 适应性
  - 易安装性
  - 易替换性

## 功能性

`功能性`及其子特性与架构本身基本无关,测试时考虑是否功能在架构中得到落实,功能的交互是否得到体现。

有些可以归结到其他质量特性,但也与功能相关,需要基于功能考虑一遍,避免遗漏，比如：

- 功能逻辑的上下文（前后依赖），结合使用场景，看功能需求是否完善，有无未考虑的特殊情况
- 非法/意外事件，虽然可以从可靠性质量特性出发，但基于功能来考量也是有必要的
- 实时性要求，性能效率质量特性有类似要求，这里从用户使用的角度考察实时性要求，并考虑异常处理。

## 可靠性

`可靠性`有以下四个子特性

- 成熟性（相关）
- 可用性（相关）
- 容错性（此架构中易出问题）
- 易恢复性（此架构中易出问题）

在容错性和易回复性易出错的功能组件有：

- 事件通知的编码解码。负责编解码的库可能出现缓存溢出，数据编码解码错误，解码缓存溢出等问题。另外要注意可以正确处理可能的输入数据错误，可以考虑使用边界值等价类的方法对事件通知的消息内容参数进行取值分析，进一步找出容易出错的参数取值组合
- 事件通知的发送和接收。注意消息的丢失，重复，系统是否还有容错和恢复机制的要求。一般使用场景法设计用例
- 事件队列的管理与维护。场景缺陷为事件队列溢出，尤其是嵌入式系统或者大容量的并发服务器系统中。需要识别溢出并根据具体业务需求做对应处理，最基础的处理十八溢出情况记录在系统日志中，以便后续分析。
- 事件的注测与注销。遗漏事件注册，对未注册的事件进行注销，重复注册等情况。从容错和恢复性的要求，系统应能识别重复注册或忽略重复注册，对非法注销返回合适的错误码。对这类缺陷，一般代码评审、单元测试层面的测试更有效。
- 事件的优先级（可选）。大部分架构并不设优先级，但对于嵌入式系统，处于实时性目的可能会设置优先级。需要注意优先级倒挂的问题，如果要优先级的任务依赖于低优先级的任务或者某些共用的硬件资源，可能会发生死锁。一般通过场景法分析，枚举可能的事件序列，静态测试会更有效。
- 事件与注册记录的匹配和过滤。常见缺陷是对合法事件识别有无，比如将其识别为未知事件然后丢掉。注册列表上注册模块的事件转发逻辑也易出错。单元测试中使用基于结构的测试设计方法来发现此问题，使用等价类决策表对事件通知匹配相关参数进行分析。
- 事件的广播和转发。有易恢复性要求的系统中常见缺陷是事件广播，转发出现异常后所有未出现异常的处理逻辑都被锁定。一般通过静态分析系统设计逻辑是否有合理覆盖此类要求。
- 事件处理后的返回和/或后续处理（可选）。常见缺陷有未定义处理错误时的返回码，对事件返回的错误码处理不符合功能逻辑要求等。对于有链式事件处理的系统，需要结合场景法额外注意其中复杂的依赖关系。

## 性能效率

`性能效率`有以下三个子特性

- 时间特性（此架构中大部分功能组件易出问题）
- 资源利用性（此架构中大部分功能组件易出问题）
- 容量（此架构中大部分功能组件易出问题）

容易在性能效率上出现缺陷的组件有：

- 事件通知的编码解码。容易出现的缺陷为编解码耗时过长（此函数一般频繁调用，容易成为系统瓶颈）。需要度量编解码函数的CPU占用时间和估计调用频率。考虑编解码中CPU占用，以及内存缓存的占用情况，考虑数据为空的情况。以上测试设计都可结合等价类边界值的方法来考虑不同编解码内容，不同调用频率的场景。
- 时间通知的发送与接收。容易出现的消息延迟的问题。时间驱动架构中各个模块一般在同一处理器上运行（线程或进程），存在竞争，有实时性要求的系统需要给ii事件收发安排一个高优先级的线程/进程。考虑处理器事件被昌吉占用导致的可能缺陷。容量方面考虑数据量大的事件，超出系统处理容量的大量事件。
- 事件队列的管理与维护。常见缺陷为高优先级事件尝试几件得不到处理。
- 事件的注册与注销常见缺陷有事件注销后相关注册数据没有删除导致资源占用（结合具体业务考虑是否要删除）
- 事件的优先级（可选）。优先级错误等导致事件得不到及时响应甚至溢出（超出容量）
- 事件与注册记录的匹配过滤。核心组件，易出现实时性要求不满足的问题。
- 事件的广播与转发。事件转发/广播过慢，广播资源占用过多甚至超出系统缓存容量。
- 事件处理机制的调用方法。当系统较复杂，跨物理主机时，这个功能可能不满足事件特性的要求。
- 事件处理后发返回和/或后续处理（可选）。易出现后续处理过慢，资源占用，阻塞等问题。
- 事件通道的创建、管理与维护（可选）。要留意资源占用与容量的平衡，尤其在嵌入式的小型系统中。

## 易用性

事件驱动架构作为架构范式，此处的易用性质量特性是对于在此架构上编写代码的开发人员来说，比如编程接口（API）是否容易理解，行为是否符合预期等

- 事件通知的编解码。最常见的就是异常数据参数等情况，未返回合适的易于理解的错误信息，不利于诊断分析。
- 事件的通知和发送。常见缺陷是对异常的数据发送未作保护。比如事件驱动系统处于一种不能接受外部消息的状态下，外部向其发送事件通知导致系统崩溃等异常。
- 事件的注册/注销。常见缺陷未，重复注册，未注册先注销等导致意外结果。

## 信息安全性

`信息安全性`有以下四个子特性：

- 保密性
- 完整性
- 抗抵赖性
- 可核查性
- 真实性

主要体现在系统对外的接口上可能有加密需要，具体看系统需要满足哪些子特性；系统内部相互之间处于性能效率的考量，信息安全的要求相对较少。

当事件驱动架构实现的系统有多个地域不同网段的子系统构成时，要进一步考虑各个组件直接的信息安全问题。

## 兼容性

`兼容性`有以下子特性：

- 共存性
- 互操作性

在事件驱动架构中，重点考虑与外部系统发生联系的组件。

## 维护性

-`维护性`有以下子特性：

- 模块化
- 可重用性
- 易分析性
- 易修改性
- 易测试性

架构本身提供了模块化范式，可重用性，易分析性，易修改性都有很好的表现。

至于易测试性，通常在各个架构组件中引入可测试性，事件收发机制中，植入对事件健康，修改，比对等测试功能。在事件队列和分发器组件中，提供足够的log信息。在事件注册/注销中，可提供隐含的测试模块的注册能力以便将所有事件转发到测试模块。对于事件处理机制的调用，可提供狗子方法供测试模块监控甚至修改事件的处理逻辑和返回。

## 可移植性

事件驱动架构通过架构范式提供的很好的可移植性，一般不会有这方面的问题。